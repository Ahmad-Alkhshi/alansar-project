# شرح منطق الهامش الاستثنائي

## القواعد الأساسية

### 1. الحدود المالية
- **الحد الأساسي**: 500,000 ليرة سورية
- **الهامش الاستثنائي**: 10,000 ليرة سورية
- **الحد الأقصى**: 510,000 ليرة سورية

### 2. متى يُسمح بالهامش؟

الهامش يُستخدم **فقط** عندما يكون من المستحيل الوصول إلى 500,000 أو أقل بحذف أي منتج من السلة.

---

## الخوارزمية

```typescript
إذا كان المجموع <= 500,000:
  ✅ مسموح

إذا كان المجموع > 510,000:
  ❌ ممنوع (تجاوز الحد الأقصى)

إذا كان المجموع بين 500,001 و 510,000:
  احسب الفارق = المجموع - 500,000
  ابحث عن أصغر منتج في السلة
  
  إذا كان (سعر أصغر منتج > الفارق):
    ✅ يُسمح بالهامش (لا يمكن حذف منتج للوصول لـ 500,000)
  وإلا:
    ❌ لا يُسمح (يمكن حذف منتج صغير والوصول لـ 500,000)
```

---

## أمثلة توضيحية

### مثال 1: يُسمح بالهامش ✅

**السلة:**
- منتج A: 250,000 ل.س
- منتج B: 200,000 ل.س
- منتج C: 55,000 ل.س

**المجموع**: 505,000 ل.س  
**الفارق**: 5,000 ل.س  
**أصغر منتج**: 55,000 ل.س

**النتيجة**: ✅ يُسمح بالهامش

**السبب**: لا يمكن حذف أي منتج لأن أصغر منتج (55,000) أكبر من الفارق (5,000)

---

### مثال 2: لا يُسمح بالهامش ❌

**السلة:**
- منتج A: 250,000 ل.س
- منتج B: 200,000 ل.س
- منتج C: 55,000 ل.س
- منتج D: 3,000 ل.س

**المجموع**: 508,000 ل.س  
**الفارق**: 8,000 ل.س  
**أصغر منتج**: 3,000 ل.س

**النتيجة**: ❌ لا يُسمح

**السبب**: يمكن حذف المنتج D (3,000) والوصول إلى 505,000 (ضمن الهامش المسموح)

---

### مثال 3: يُسمح بالهامش ✅

**السلة:**
- منتج A: 300,000 ل.س
- منتج B: 150,000 ل.س
- منتج C: 60,000 ل.س

**المجموع**: 510,000 ل.س  
**الفارق**: 10,000 ل.س  
**أصغر منتج**: 60,000 ل.س

**النتيجة**: ✅ يُسمح بالهامش

**السبب**: أصغر منتج (60,000) أكبر من الفارق (10,000)، لذلك لا يمكن الوصول لـ 500,000 بحذف أي منتج

---

### مثال 4: لا يُسمح - تجاوز الحد الأقصى ❌

**السلة:**
- منتج A: 300,000 ل.س
- منتج B: 200,000 ل.س
- منتج C: 15,000 ل.س

**المجموع**: 515,000 ل.س

**النتيجة**: ❌ ممنوع تماماً

**السبب**: تجاوز الحد الأقصى (510,000)

---

## الرسائل للمستخدم

### عند السماح بالهامش:
```
"تم استخدام الهامش الاستثنائي (+5,000 ل.س)"
```

### عند عدم السماح:
```
"لقد تجاوزت الـ 500,000 ل.س. يمكنك حذف منتج صغير للبقاء ضمن الحد المسموح."
```

### عند تجاوز الحد الأقصى:
```
"تجاوزت الحد الأقصى المسموح (510,000 ل.س)"
```

---

## التطبيق في الكود

الكود موجود في: `lib/margin-logic.ts`

الدالة الرئيسية: `checkMarginAllowed(items: CartItem[])`

يتم استدعاؤها في:
1. عند إضافة منتج للسلة (Frontend + Backend)
2. عند تأكيد الطلب (Backend فقط)

---

## الفوائد

✅ **عادل**: يمنع التلاعب  
✅ **مرن**: يسمح بحالات استثنائية حقيقية  
✅ **واضح**: رسائل مفهومة للمستخدم  
✅ **آمن**: التحقق في السيرفر  

---

## ملاحظات مهمة

1. التحقق يتم في **السيرفر** وليس فقط في الواجهة
2. لا يمكن التلاعب بالأسعار من جهة العميل
3. يتم حساب "أصغر منتج" بناءً على (السعر × الكمية)
4. الهامش يُحسب على المجموع النهائي فقط
